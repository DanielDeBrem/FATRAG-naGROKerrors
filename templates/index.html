<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FATRAG - Financial Advisory Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .loading-spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <h1 class="text-2xl font-bold text-gray-900">
                        <i class="fas fa-chart-line text-blue-600 mr-2"></i>
                        FATRAG
                    </h1>
                    <span class="ml-4 text-sm text-gray-500">Financial Advisory Tool</span>
                </div>
                <nav class="flex space-x-8">
                    <a href="/" class="text-gray-900 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">Home</a>
                    <a href="/admin" class="text-gray-500 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">Admin</a>
                    <a href="/docs" class="text-gray-500 hover:text-gray-900 px-3 py-2 rounded-md text-sm font-medium">API Docs</a>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
        <!-- Search Section -->
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-search mr-2"></i>
                Stel uw vraag
            </h2>
            
            <div class="space-y-4">
                <div>
                    <textarea 
                        id="queryInput" 
                        rows="4" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="Typ uw financiÃ«le vraag hier..."
                    ></textarea>
                </div>
                
                <div class="flex items-center space-x-4">
                    <select id="queryType" class="px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="general">Algemeen</option>
                        <option value="financial">Financieel</option>
                        <option value="compliance">Compliance</option>
                        <option value="tax">Fiscaal</option>
                    </select>
                    
                    <button 
                        id="askButton" 
                        class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 disabled:opacity-50"
                    >
                        <i class="fas fa-paper-plane mr-2"></i>
                        Vraag stellen
                    </button>
                </div>
            </div>
        </div>

        <!-- Loading State -->
        <div id="loadingState" class="hidden bg-blue-50 border border-blue-200 rounded-lg p-6 mb-6">
            <div class="flex items-center">
                <div class="loading-spinner mr-4"></div>
                <div>
                    <p class="text-blue-800 font-medium">Bezig met verwerken...</p>
                    <p class="text-blue-600 text-sm">We zoeken naar relevante informatie in de documenten.</p>
                </div>
            </div>
        </div>

        <!-- Response Section -->
        <div id="responseSection" class="hidden bg-white rounded-lg shadow p-6 mb-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-reply mr-2"></i>
                Antwoord
            </h3>
            
            <div id="responseText" class="prose max-w-none mb-4"></div>
            
            <div class="flex items-center justify-between text-sm text-gray-500 mb-4">
                <span id="confidenceScore"></span>
                <span id="responseTime"></span>
            </div>
            
            <!-- Sources -->
            <div id="sourcesSection" class="border-t pt-4">
                <h4 class="font-medium text-gray-900 mb-2">
                    <i class="fas fa-book mr-2"></i>
                    Bronnen
                </h4>
                <div id="sourcesList" class="space-y-2"></div>
            </div>
            
            <!-- Feedback -->
            <div id="feedbackSection" class="border-t pt-4 mt-4">
                <h4 class="font-medium text-gray-900 mb-2">Was dit antwoord nuttig?</h4>
                <div class="flex items-center space-x-2">
                    <button class="feedback-btn px-3 py-1 bg-green-100 text-green-800 rounded hover:bg-green-200" data-rating="5">
                        <i class="fas fa-thumbs-up mr-1"></i> Zeer nuttig
                    </button>
                    <button class="feedback-btn px-3 py-1 bg-yellow-100 text-yellow-800 rounded hover:bg-yellow-200" data-rating="3">
                        <i class="fas fa-meh mr-1"></i> Gemiddeld
                    </button>
                    <button class="feedback-btn px-3 py-1 bg-red-100 text-red-800 rounded hover:bg-red-200" data-rating="1">
                        <i class="fas fa-thumbs-down mr-1"></i> Niet nuttig
                    </button>
                </div>
            </div>
        </div>

        <!-- History Section -->
        <div class="bg-white rounded-lg shadow p-6">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">
                <i class="fas fa-history mr-2"></i>
                Geschiedenis
            </h3>
            
            <div id="historyList" class="space-y-3">
                <p class="text-gray-500 text-center py-4">Nog geen vragen gesteld.</p>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t mt-12">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8">
            <div class="text-center text-gray-500 text-sm">
                <p>&copy; 2025 FATRAG - Financial Advisory Tool. Alle rechten voorbehouden.</p>
            </div>
        </div>
    </footer>

    <script>
        let currentSessionId = localStorage.getItem('fatrag_session_id') || generateSessionId();
        localStorage.setItem('fatrag_session_id', currentSessionId);
        
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        function showLoading() {
            document.getElementById('loadingState').classList.remove('hidden');
            document.getElementById('responseSection').classList.add('hidden');
            document.getElementById('askButton').disabled = true;
        }

        function hideLoading() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('askButton').disabled = false;
        }

        function formatConfidence(score) {
            const percentage = Math.round(score * 100);
            let color = 'red';
            if (percentage >= 80) color = 'green';
            else if (percentage >= 60) color = 'yellow';
            
            return `<span class="text-${color}-600">Betrouwbaarheid: ${percentage}%</span>`;
        }

        function formatTime(ms) {
            return `Antwoordtijd: ${(ms / 1000).toFixed(2)}s`;
        }

        function formatSource(source) {
            return `
                <div class="bg-gray-50 p-3 rounded border">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h5 class="font-medium text-gray-900">${source.document_title}</h5>
                            <p class="text-sm text-gray-600">
                                ${source.document_company ? `Bedrijf: ${source.document_company}` : ''}
                                ${source.page_number ? ` | Pagina: ${source.page_number}` : ''}
                            </p>
                            ${source.section_title ? `<p class="text-sm text-gray-500">${source.section_title}</p>` : ''}
                        </div>
                        <span class="text-xs text-gray-400">Score: ${(source.score * 100).toFixed(1)}%</span>
                    </div>
                </div>
            `;
        }

        function addToHistory(query, response) {
            const historyList = document.getElementById('historyList');
            
            // Remove "no questions" message if it exists
            const emptyMessage = historyList.querySelector('.text-gray-500');
            if (emptyMessage) {
                emptyMessage.remove();
            }
            
            const historyItem = document.createElement('div');
            historyItem.className = 'border-l-4 border-blue-500 pl-4 py-2';
            historyItem.innerHTML = `
                <div class="font-medium text-gray-900">${query}</div>
                <div class="text-sm text-gray-600 mt-1">${response.substring(0, 100)}${response.length > 100 ? '...' : ''}</div>
                <div class="text-xs text-gray-400 mt-1">${new Date().toLocaleString('nl-NL')}</div>
            `;
            
            historyList.insertBefore(historyItem, historyList.firstChild);
            
            // Keep only last 10 items
            while (historyList.children.length > 10) {
                historyList.removeChild(historyList.lastChild);
            }
        }

        async function askQuestion() {
            const queryInput = document.getElementById('queryInput');
            const queryType = document.getElementById('queryType').value;
            const query = queryInput.value.trim();
            
            if (!query) {
                alert('Voer alstublieft een vraag in.');
                return;
            }
            
            showLoading();
            
            try {
                const response = await fetch('/api/queries/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query_text: query,
                        query_type: queryType,
                        session_id: currentSessionId,
                        language: 'nl',
                        max_results: 10
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    displayResponse(data);
                    addToHistory(query, data.response_text);
                    queryInput.value = '';
                } else {
                    throw new Error(data.detail || 'Er is een fout opgetreden');
                }
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('responseText').innerHTML = `
                    <div class="bg-red-50 border border-red-200 text-red-800 p-4 rounded">
                        <i class="fas fa-exclamation-triangle mr-2"></i>
                        Er is een fout opgetreden: ${error.message}
                    </div>
                `;
                document.getElementById('responseSection').classList.remove('hidden');
            } finally {
                hideLoading();
            }
        }

        function displayResponse(data) {
            document.getElementById('responseText').innerHTML = `
                <div class="prose prose-lg max-w-none">
                    ${data.response_text.replace(/\n/g, '<br>')}
                </div>
            `;
            
            document.getElementById('confidenceScore').innerHTML = formatConfidence(data.confidence_score);
            document.getElementById('responseTime').innerHTML = formatTime(data.response_time_ms);
            
            // Display sources
            if (data.sources && data.sources.length > 0) {
                document.getElementById('sourcesList').innerHTML = data.sources.map(formatSource).join('');
                document.getElementById('sourcesSection').classList.remove('hidden');
            } else {
                document.getElementById('sourcesSection').classList.add('hidden');
            }
            
            document.getElementById('responseSection').classList.remove('hidden');
            
            // Store query ID for feedback
            document.getElementById('responseSection').dataset.queryId = data.query_id;
        }

        async function submitFeedback(rating) {
            const responseSection = document.getElementById('responseSection');
            const queryId = responseSection.dataset.queryId;
            
            if (!queryId) return;
            
            try {
                const response = await fetch(`/api/queries/${queryId}/feedback`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query_id: parseInt(queryId),
                        rating: rating
                    })
                });
                
                if (response.ok) {
                    // Disable feedback buttons
                    document.querySelectorAll('.feedback-btn').forEach(btn => {
                        btn.disabled = true;
                        btn.classList.add('opacity-50', 'cursor-not-allowed');
                    });
                    
                    // Show thank you message
                    const feedbackSection = document.getElementById('feedbackSection');
                    const thankYou = document.createElement('div');
                    thankYou.className = 'text-green-600 text-sm mt-2';
                    thankYou.innerHTML = '<i class="fas fa-check mr-1"></i> Bedankt voor uw feedback!';
                    feedbackSection.appendChild(thankYou);
                }
            } catch (error) {
                console.error('Error submitting feedback:', error);
            }
        }

        // Event listeners
        document.getElementById('askButton').addEventListener('click', askQuestion);
        
        document.getElementById('queryInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && e.ctrlKey) {
                askQuestion();
            }
        });
        
        document.querySelectorAll('.feedback-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                submitFeedback(parseInt(btn.dataset.rating));
            });
        });
        
        // Load history on page load
        window.addEventListener('load', async () => {
            try {
                const response = await fetch(`/api/queries/sessions/${currentSessionId}`);
                if (response.ok) {
                    const data = await response.json();
                    if (data.queries && data.queries.length > 0) {
                        const historyList = document.getElementById('historyList');
                        historyList.innerHTML = '';
                        
                        data.queries.slice().reverse().forEach(query => {
                            const historyItem = document.createElement('div');
                            historyItem.className = 'border-l-4 border-blue-500 pl-4 py-2';
                            historyItem.innerHTML = `
                                <div class="font-medium text-gray-900">${query.query_text}</div>
                                <div class="text-sm text-gray-600 mt-1">${query.response_text.substring(0, 100)}${query.response_text.length > 100 ? '...' : ''}</div>
                                <div class="text-xs text-gray-400 mt-1">${new Date(query.created_at).toLocaleString('nl-NL')}</div>
                            `;
                            historyList.appendChild(historyItem);
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading history:', error);
            }
        });
    </script>
</body>
</html>
